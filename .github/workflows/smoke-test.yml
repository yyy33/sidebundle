name: smoke-tests

on:
  workflow_dispatch:
  push:
    branches: [main]
    tags:
      - "v*"
  pull_request:
    branches:
      - "**"

jobs:
  smoke:
    name: smoke (trace=combined)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run smoke tests in privileged container
        uses: addnab/docker-run-action@v3
        with:
          image: ubuntu:22.04
          # Mount the checked-out repo into the container and run with needed privs.
          options: --privileged --security-opt seccomp=unconfined -v ${{ github.workspace }}:/github/workspace
          workdir: /github/workspace
          run: |
            bash -eo pipefail -c '
              mkdir -p /github/workspace/target
              APT_LOG=/github/workspace/target/apt-setup.log
              echo "Setting up build environment (logs: $APT_LOG)"
              apt-get update -qq >>"$APT_LOG" 2>&1
              DEBIAN_FRONTEND=noninteractive apt-get install -yqq \
                bubblewrap sudo curl build-essential \
                nodejs npm python3 python3-pip openjdk-17-jdk \
                ca-certificates git pkg-config libssl-dev bash >>"$APT_LOG" 2>&1
              # Install Rust via rustup
              curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable
              export PATH="$HOME/.cargo/bin:$PATH"
              cd /github/workspace
              echo "Building sidebundle-cli (logs: /github/workspace/target/cargo-build.log)"
              cargo build --release -p sidebundle-cli >/github/workspace/target/cargo-build.log 2>&1
              SB_TRACE_BACKEND=combined SB_LOG_LEVEL=info scripts/bwrap_smoke.sh
            '

      - name: Verify bwrap bundles on different base image
        uses: addnab/docker-run-action@v3
        with:
          image: debian:12-slim
          options: --privileged --security-opt seccomp=unconfined -v ${{ github.workspace }}:/github/workspace
          workdir: /github/workspace
          run: |
            bash -eo pipefail -c '
              OUT_DIR=/github/workspace/target/smoke-$(uname -m)
              echo "Verifying bwrap bundles from $OUT_DIR on debian:12-slim"
              if [[ ! -d "$OUT_DIR" ]]; then
                echo "bwrap-smoke output not found at $OUT_DIR"
                exit 1
              fi
              APT_LOG=/github/workspace/target/apt-verify-bwrap.log
              apt-get update -qq >>"$APT_LOG" 2>&1
              DEBIAN_FRONTEND=noninteractive apt-get install -yqq bubblewrap >>"$APT_LOG" 2>&1
              try_run() { local path="$1"; shift; if [[ -x "$path" ]]; then echo "-> $path $*"; "$path" "$@"; else echo "skip missing $path"; fi; }
              try_run "$OUT_DIR/node/bin/node" -e "console.log(\"verify-node\")"
              try_run "$OUT_DIR/python3/bin/python3" -c "import sys;print(\"verify-python\", sys.version.split()[0])"
              try_run "$OUT_DIR/java/bin/java" -version
              try_run "$OUT_DIR/pip3/bin/pip3" --version
              # TODO(test_cover): re-enable npm verification once npm bundling is stable again.
              # try_run "$OUT_DIR/npm/bin/npm" --version
            '

  host-smoke:
    name: host smoke (build + self-verify)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run host-mode smoke tests in privileged container
        uses: addnab/docker-run-action@v3
        with:
          image: ubuntu:22.04
          options: --privileged --security-opt seccomp=unconfined -v ${{ github.workspace }}:/github/workspace
          workdir: /github/workspace
          run: |
            bash -eo pipefail -c '
              mkdir -p /github/workspace/target
              APT_LOG=/github/workspace/target/apt-host-smoke.log
              echo "Setting up host-smoke environment (logs: $APT_LOG)"
              apt-get update -qq >>"$APT_LOG" 2>&1
              DEBIAN_FRONTEND=noninteractive apt-get install -yqq \
                sudo curl build-essential \
                nodejs npm python3 python3-pip \
                ffmpeg lldb ca-certificates git pkg-config libssl-dev bash >>"$APT_LOG" 2>&1
              curl https://sh.rustup.rs -sSf | sh -s -- -y --default-toolchain stable
              export PATH="$HOME/.cargo/bin:$PATH"
              cd /github/workspace
              echo "Building sidebundle-cli (logs: /github/workspace/target/cargo-host-build.log)"
              cargo build --release -p sidebundle-cli >/github/workspace/target/cargo-host-build.log 2>&1
              SB_TRACE_BACKEND=auto SB_LOG_LEVEL=info scripts/host_smoke.sh
            '

      - name: Verify host bundles on different base image
        uses: addnab/docker-run-action@v3
        with:
          image: debian:12-slim
          options: --privileged --security-opt seccomp=unconfined -v ${{ github.workspace }}:/github/workspace
          workdir: /github/workspace
          run: |
            bash -eo pipefail -c '
              OUT_DIR=/github/workspace/target/host-smoke-$(uname -m)
              echo "Verifying bundles from $OUT_DIR on debian:12-slim"
              if [[ ! -d "$OUT_DIR" ]]; then
                echo "host-smoke output not found at $OUT_DIR"
                exit 1
              fi
              try_run() { local path="$1"; shift; if [[ -x "$path" ]]; then echo "-> $path $*"; "$path" "$@"; else echo "skip missing $path"; fi; }
              try_run "$OUT_DIR/ls/bin/ls" --version
              try_run "$OUT_DIR/curl/bin/curl" --version
              try_run "$OUT_DIR/ffmpeg/bin/ffmpeg" -version
              try_run "$OUT_DIR/lldb/bin/lldb" --version
              try_run "$OUT_DIR/node/bin/node" -e "console.log(\"verify-node\")"
              try_run "$OUT_DIR/tar/bin/tar" --version
              try_run "$OUT_DIR/npm/bin/npm" --version
              try_run "$OUT_DIR/hello-sh/bin/hello.sh"
              try_run "$OUT_DIR/pip3/bin/pip3" --version
            '
